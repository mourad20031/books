// optimizations.js
(function() {
    // Preconnect to critical domains
    const preconnect = (url) => {
        const link = document.createElement('link');
        link.rel = 'preconnect';
        link.href = url;
        link.crossOrigin = 'anonymous';
        document.head.appendChild(link);
    };
    
    // Preconnect to CDNs
    preconnect('https://fonts.googleapis.com');
    preconnect('https://fonts.gstatic.com');
    preconnect('https://cdnjs.cloudflare.com');
    preconnect('https://i.postimg.cc');
    
    // Preload critical resources
    const preload = (url, as) => {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.href = url;
        link.as = as;
        document.head.appendChild(link);
    };
    
    // Image optimization: Lazy load images
    document.addEventListener('DOMContentLoaded', function() {
        const images = document.querySelectorAll('img.book-image');
        
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.classList.add('loaded');
                    }
                    imageObserver.unobserve(img);
                }
            });
        }, { rootMargin: '50px' });
        
        images.forEach(img => {
            // Store original src
            img.dataset.src = img.src;
            // Set placeholder or low-quality src initially
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjFmNWY5Ii8+PC9zdmc+';
            img.classList.add('lazy');
            imageObserver.observe(img);
        });
        
        // Optimize video for mobile
        const video = document.querySelector('#video-section video');
        if (video && window.innerWidth < 768) {
            video.preload = 'none';
        }
    });
    
    // Load non-critical CSS asynchronously
    const loadCSS = (href) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.media = 'print';
        link.onload = () => { link.media = 'all'; };
        document.head.appendChild(link);
    };
    
    // Delay loading of FontAwesome and Google Fonts
    setTimeout(() => {
        loadCSS('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css');
        loadCSS('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    }, 1000);
})();
